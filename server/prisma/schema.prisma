generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  AGENCY
  WORKER
}

enum AgencyRole {
  WORKER
  MANAGER
  OWNER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum Status {
  ACTIVE
  PENDING
  REJECTED
}

enum TokenType {
  EMAIL_VERIFY // email confirmation after agency self-registers
  INVITE // invite link (agency or worker)
  MAGIC_LOGIN // passwordless one-time login for workers
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email        String  @unique
  name         String?
  passwordHash String? // agency users set this at registration; workers optionally later
  role         Role    @default(AGENCY)
  verified     Boolean @default(false) // must confirm email before login (self-registered agencies)
  invited      Boolean @default(false) // true if created from an invite

  // Memberships to agencies (owner/worker)
  memberships UserAgency[]

  // Clients
  clients Client[]

  // Emails & login tokens
  tokens Token[]

  // Tasks assigned (optional)
  assignedTasks Task[] @relation("TaskAssignee")
  createdTasks  Task[] @relation("TaskCreator")

  @@map("users")
}

model Agency {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name      String
  subdomain String? @unique // e.g., acme â†’ acme.yourseodashboard.com

  // Memberships (owner(s) and workers)
  members UserAgency[]

  // Works
  tasks Task[]

  // Tokens for invitations
  tokens Token[]

  @@map("agencies")
}

model UserAgency {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Per-agency role (owner/manager/worker). Use Role.AGENCY here for owners/managers in MVP.
  agencyRole AgencyRole @default(WORKER)

  @@unique([userId, agencyId])
  @@index([agencyId])
  @@index([userId])
  @@map("user_agencies")
}

model Task {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String?
  category    String?
  dueDate     DateTime?
  status      TaskStatus @default(TODO)

  // Tenant scope
  agencyId String
  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Who created it (agency owner/worker/admin)
  createdById String?
  createdBy   User?   @relation("TaskCreator", fields: [createdById], references: [id], onDelete: SetNull)

  // Who it's assigned to
  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  // who it is for
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  @@index([agencyId, status])
  @@index([assigneeId])
  @@map("tasks")
}

model Token {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  type      TokenType
  email     String // the email this token is for
  token     String    @unique @db.VarChar(500) // in prod: store a hash instead of raw token
  expiresAt DateTime

  // Optional scoping
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  agencyId String?
  agency   Agency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  role Role? // target role for INVITE (AGENCY/WORKER)

  metadata Json? @db.Json

  @@index([type, email])
  @@map("tokens")
}

model Client {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name     String  @unique
  domain   String  @unique
  industry String?
  targets  Json?   @db.Json
  status   Status  @default(PENDING)

  userId String
  user   User   @relation(fields: [userId], references: [id])
  Task   Task[]

  @@index([name, domain])
  @@map("clients")
}
